generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(user)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tickets         Ticket[] @relation("MerchantTickets")
  assignedTickets Ticket[] @relation("AssignedTickets")

  @@map("users")
}

model Ticket {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  ticketId          String       @unique
  merchantId        String       @db.ObjectId
  merchant          User         @relation("MerchantTickets", fields: [merchantId], references: [id])
  assignedAgentId   String?      @db.ObjectId
  assignedAgent     User?        @relation("AssignedTickets", fields: [assignedAgentId], references: [id])
  status            TicketStatus @default(open)
  priority          Priority     @default(medium)
  title             String?
  isEscalated       Boolean      @default(false)
  escalatedAt       DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  chatHistory ChatHistory?

  @@index([merchantId])
  @@index([assignedAgentId])
  @@map("tickets")
}

model ChatHistory {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  sessionId String        @unique @db.ObjectId
  ticket    Ticket        @relation(fields: [sessionId], references: [id])
  messages  ChatMessage[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@map("chat_histories")
}

type ChatMessage {
  role      String
  content   String
  timestamp DateTime @default(now())
  cards     Json?
  toolsUsed String[]
  isHuman   Boolean  @default(false)
}

enum TicketStatus {
  open
  in_progress
  escalated
  resolved
  closed
}

enum Priority {
  low
  medium
  high
  urgent
}

enum UserRole {
  user
  admin
}
